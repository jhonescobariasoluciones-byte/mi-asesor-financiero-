<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Perfiles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Gestionar Perfiles</h1>
            <p class="text-slate-600 mt-2">Crea perfiles personales o compartidos para gestionar diferentes finanzas.</p>
            <a href="index.html" class="text-indigo-600 font-semibold mt-4 inline-block hover:underline">← Volver al Diagnóstico</a>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Mis Perfiles</h2>
            <div id="profiles-list" class="space-y-3"></div>
            <button id="add-profile-btn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Crear Nuevo Perfil</button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-semibold mb-4">Unirse a un Perfil Compartido</h2>
            <p class="text-sm text-slate-500 mb-2">Si alguien te dio un código de invitación, ingrésalo aquí.</p>
            <form id="join-profile-form" class="flex gap-4">
                <input type="text" id="join-code-input" placeholder="Ej: FAMILIA-1234" class="flex-grow p-2 border border-slate-300 rounded-md" required>
                <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Unirse</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const profilesListEl = document.getElementById('profiles-list');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const joinProfileForm = document.getElementById('join-profile-form');
        const joinCodeInput = document.getElementById('join-code-input');

        let userId;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                loadProfiles();
            }
        });

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else if (!auth.currentUser) {
                await signInAnonymously(auth);
            }
        }

        async function loadProfiles() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
            const userDoc = await getDoc(userDocRef);
            const profiles = userDoc.exists() ? userDoc.data().profiles || [] : [];
            
            if (profiles.length === 0) {
                const newProfileId = `profile_${Date.now()}`;
                const newProfile = { id: newProfileId, name: 'Personal', type: 'personal' };
                profiles.push(newProfile);
                await setDoc(userDocRef, { profiles });
                localStorage.setItem('activeProfileId', newProfileId);
            }
            renderProfiles(profiles);
        }

        function renderProfiles(profiles) {
            profilesListEl.innerHTML = '';
            const activeProfileId = localStorage.getItem('activeProfileId');

            profiles.forEach(profile => {
                const isActive = profile.id === activeProfileId;
                const profileEl = document.createElement('div');
                profileEl.className = `p-4 border rounded-lg flex items-center justify-between ${isActive ? 'bg-indigo-50 border-indigo-300' : 'bg-slate-50'}`;
                profileEl.innerHTML = `
                    <div>
                        <p class="font-bold">${profile.name}</p>
                        <p class="text-xs text-slate-500">${profile.type === 'shared' ? `Compartido (Código: ${profile.id.split('_')[1]})` : 'Personal'}</p>
                    </div>
                    <div class="flex gap-2">
                        ${!isActive ? `<button data-id="${profile.id}" class="select-btn text-sm bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600">Activar</button>` : '<span class="text-sm font-bold text-indigo-700">Activo</span>'}
                    </div>
                `;
                profilesListEl.appendChild(profileEl);
            });
        }

        addProfileBtn.addEventListener('click', async () => {
            const name = prompt('Ingresa el nombre del nuevo perfil (ej: Familia Pérez):');
            if (name) {
                const type = 'shared'; // For simplicity, new profiles are shared
                const profileId = `profile_${Date.now()}`;
                
                // Create profile document in public space
                const profileDocRef = doc(db, `artifacts/${appId}/public/data/${profileId}`);
                await setDoc(profileDocRef, { name, members: [userId] });

                // Add profile to user's list
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                await updateDoc(userDocRef, {
                    profiles: arrayUnion({ id: profileId, name, type })
                });
                loadProfiles();
            }
        });

        joinProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = joinCodeInput.value.trim();
            const profileId = `profile_${code}`;
            
            const profileDocRef = doc(db, `artifacts/${appId}/public/data/${profileId}`);
            const profileDoc = await getDoc(profileDocRef);

            if (profileDoc.exists()) {
                const profileData = profileDoc.data();
                // Add user to members list in the shared profile
                await updateDoc(profileDocRef, { members: arrayUnion(userId) });
                
                // Add profile to user's list
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                await updateDoc(userDocRef, {
                    profiles: arrayUnion({ id: profileId, name: profileData.name, type: 'shared' })
                });
                alert('¡Te has unido al perfil con éxito!');
                loadProfiles();
            } else {
                alert('Código de perfil no encontrado.');
            }
        });

        profilesListEl.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('select-btn')) {
                localStorage.setItem('activeProfileId', target.dataset.id);
                loadProfiles();
            }
        });

        initAuth();
    </script>
</body>
</html>
