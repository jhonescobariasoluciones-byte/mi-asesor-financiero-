<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de Finanzas Personales</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Chart.js Datalabels Plugin for percentages -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|trash|reload" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilo personalizado para usar la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para los placeholders de los inputs */
        ::placeholder {
            color: #9ca3af;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-slate-900">¡Bienvenid@!</h2>
            <p class="text-slate-600 mt-2 mb-4">Para personalizar tu experiencia, por favor dinos tu nombre.</p>
            <form id="welcome-form">
                <input type="text" id="user-name-input" placeholder="Escribe tu nombre aquí" class="w-full p-3 border border-slate-300 rounded-md text-center" required>
                <button type="submit" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors">Comenzar</button>
            </form>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- Encabezado -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Panel de <span id="user-name-header">Salud Financiera</span></h1>
            <p class="text-slate-600 mt-2">Analiza tus finanzas, entiende tus gastos y toma el control de tu dinero.</p>
        </header>

        <!-- Selector de Moneda -->
        <div class="max-w-md mx-auto mb-8 bg-white p-4 rounded-lg shadow-md">
            <label for="currency" class="block text-sm font-medium text-slate-700 text-center">Selecciona tu moneda principal</label>
            <select id="currency" class="mt-2 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="COP">Pesos Colombianos (COP)</option>
                <option value="USD">Dólares Americanos (USD)</option>
            </select>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Columna de Entrada de Datos -->
            <div class="space-y-8">
                
                <!-- Card de Ingresos -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Ingresos Mensuales</h2>
                    <div id="incomes-container" class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-slate-700">Ingreso Principal</label>
                            <input type="text" inputmode="decimal" placeholder="Ej: 3.000.000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 data-input">
                        </div>
                    </div>
                    <button id="add-income" class="mt-4 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">+ Añadir otro ingreso</button>
                </div>

                <!-- Card de Gastos Fijos -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. Gastos Fijos Mensuales</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-slate-700">Arriendo / Hipoteca</label>
                            <input type="text" inputmode="decimal" placeholder="0" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 data-input fixed-expense">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">Servicios (Agua, Luz, Gas)</label>
                            <input type="text" inputmode="decimal" placeholder="0" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 data-input fixed-expense">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">Internet / Celular</label>
                            <input type="text" inputmode="decimal" placeholder="0" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 data-input fixed-expense">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">Suscripciones</label>
                            <input type="text" inputmode="decimal" placeholder="0" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 data-input fixed-expense" data-category="Suscripciones">
                        </div>
                    </div>
                </div>

                <!-- Card de Gastos Variables -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">3. Gastos Variables Mensuales</h2>
                    <form id="variable-expense-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="expense-desc" class="text-sm font-medium text-slate-700">Descripción</label>
                            <input type="text" id="expense-desc" placeholder="Mercado del mes" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="expense-amount" class="text-sm font-medium text-slate-700">Monto</label>
                            <input type="text" inputmode="decimal" id="expense-amount" placeholder="0" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="expense-category" class="text-sm font-medium text-slate-700">Categoría</label>
                            <select id="expense-category" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option>Alimentación</option>
                                <option>Transporte</option>
                                <option>Ocio y Entretenimiento</option>
                                <option>Educación</option>
                                <option>Salud</option>
                                <option>Ropa</option>
                                <option>Otros</option>
                            </select>
                        </div>
                        <button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">Añadir Gasto</button>
                    </form>
                    <div id="variable-expenses-list" class="mt-6">
                        <!-- Los gastos variables se añadirán aquí -->
                    </div>
                </div>
            </div>

            <!-- Columna del Dashboard de Análisis -->
            <div class="space-y-8">
                
                <div id="report-content"> <!-- Contenedor para el contenido del PDF -->
                    <!-- Resumen General -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-xl font-semibold mb-4">Análisis Financiero</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-slate-100 rounded-md">
                                <span class="font-medium">Ingresos Totales:</span>
                                <span id="total-income" class="font-bold text-lg text-green-600">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-100 rounded-md">
                                <span class="font-medium">Gastos Totales:</span>
                                <span id="total-expenses" class="font-bold text-lg text-red-600">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-indigo-100 rounded-md">
                                <span class="font-medium text-indigo-800">Ahorro Programado (Metas)</span>
                                <span id="allocated-savings" class="font-bold text-lg text-indigo-800">0</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-slate-200 rounded-md">
                                <span class="font-semibold text-lg">Flujo de Caja Real:</span>
                                <span id="cash-flow" class="font-extrabold text-2xl">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico de Gastos -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-xl font-semibold mb-4">Distribución de Gastos</h2>
                        <div class="w-full max-w-md mx-auto">
                            <canvas id="expenses-chart"></canvas>
                        </div>
                    </div>

                    <!-- Diagnóstico y Recomendaciones -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-xl font-semibold">Tu Asesor Financiero Personal</h2>
                            <button id="reset-btn" title="Resetear todos los datos" class="flex items-center gap-2 text-sm bg-slate-200 hover:bg-red-200 text-slate-700 hover:text-red-800 font-semibold py-1 px-3 rounded-lg transition-colors">
                                <i class="gg-reload"></i>
                                Resetear
                            </button>
                        </div>
                        <div id="diagnosis-container" class="space-y-4">
                            <button id="diagnose-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors text-lg">
                                Generar Diagnóstico Financiero
                            </button>
                            
                            <div id="financial-health" class="text-center p-4 rounded-lg mb-4 hidden">
                                <h3 id="health-status" class="text-lg font-bold"></h3>
                                <p id="health-message" class="mt-1 text-sm"></p>
                            </div>
                            
                            <div id="detailed-analysis" class="p-3 bg-slate-50 rounded-md border-l-4 border-blue-500 hidden">
                                <!-- Análisis detallado se insertará aquí -->
                            </div>
                            
                            <div id="recommendations" class="mt-4 space-y-4 text-sm text-slate-700 hidden">
                                <!-- Las recomendaciones se generarán aquí -->
                            </div>

                            <div id="action-path-container" class="space-y-4">
                                <!-- Los CTAs se insertarán aquí en el orden correcto -->
                            </div>
                        </div>
                    </div>
                </div>

                <button id="export-pdf-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors text-lg hidden mt-8">
                    Mi Primer Plan Financiero (PDF)
                </button>

            </div>
        </div>
    </div>
    
    <!-- Plantillas de los CTAs (ocultas) -->
    <template id="progress-cta-template">
        <div id="progress-cta-container" class="p-4 bg-blue-100 text-center rounded-lg">
            <h4 class="font-semibold text-blue-800">¡Tu esfuerzo está dando frutos!</h4>
            <p class="text-sm text-blue-700 mt-1">Hemos guardado tu historial. Visita tu dashboard de progreso para ver cómo tus decisiones están transformando tus finanzas.</p>
            <a href="progreso.html" class="mt-4 inline-block bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">
                Ver mi Progreso Histórico →
            </a>
        </div>
    </template>
     <template id="progress-onboarding-template">
        <div class="p-4 bg-blue-100 text-center rounded-lg">
            <h4 class="font-semibold text-blue-800">¡Felicidades por dar el primer paso!</h4>
            <p class="text-sm text-blue-700 mt-1">Hemos guardado la "foto" de tus finanzas de este mes. Vuelve el próximo mes para registrar tus nuevos datos y desbloquear tu Dashboard de Evolución Financiera.</p>
        </div>
    </template>
    <template id="budget-cta-template">
        <div id="budget-cta-container" class="p-4 bg-green-100 text-center rounded-lg">
            <h4 class="font-semibold text-green-800">¡Ahora, toma el control del próximo mes!</h4>
            <p class="text-sm text-green-700 mt-1">Usa tu diagnóstico para crear un presupuesto inteligente y decirle a tu dinero exactamente a dónde ir.</p>
            <a href="presupuesto.html" class="mt-4 inline-block bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors">
                Crear mi Presupuesto →
            </a>
        </div>
    </template>
    <template id="debts-cta-template">
         <div id="debts-cta-container" class="p-4 bg-red-100 text-center rounded-lg">
            <h4 class="font-semibold text-red-800">Tu principal misión es conquistar tus deudas.</h4>
            <p class="text-sm text-red-700 mt-1">Usa nuestro centro de comando para crear un plan de batalla y visualizar tu camino hacia la libertad.</p>
            <a href="deudas.html" class="mt-4 inline-block bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 transition-colors">
                Crear mi Plan Anti-Deudas →
            </a>
        </div>
    </template>
    <template id="goals-cta-template">
        <div id="goals-cta-container" class="p-4 bg-indigo-100 text-center rounded-lg">
            <h4 id="goals-cta-title" class="font-semibold text-indigo-800"></h4>
            <p id="goals-cta-text" class="text-sm text-indigo-700 mt-1"></p>
            <a href="metas.html" id="go-to-goals-btn" class="mt-4 inline-block bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors"></a>
        </div>
    </template>
     <template id="investor-profile-template">
        <div id="investor-profile-container" class="p-4 bg-slate-100 rounded-lg">
            <h4 class="font-semibold text-center text-slate-800 mb-3">¿Listo para Invertir? Define tu Perfil</h4>
            <p class="text-center text-xs text-slate-600 mb-3">Tu elección determinará las estrategias de inversión recomendadas.</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <button data-profile="conservador" class="profile-btn w-full bg-sky-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-sky-700 transition-colors">Conservador</button>
                <button data-profile="moderado" class="profile-btn w-full bg-amber-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-amber-700 transition-colors">Moderado</button>
                <button data-profile="agresivo" class="profile-btn w-full bg-red-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-red-700 transition-colors">Agresivo</button>
            </div>
        </div>
    </template>
    <template id="investment-recommendations-template">
        <div id="investment-recommendations" class="mt-4 space-y-4 text-sm text-slate-700"></div>
    </template>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let state = {
                currency: 'COP',
                variableExpenses: [],
                currentDiagnosis: null,
                investorProfile: null,
            };
            let expenseChart = null;

            // --- DOM ELEMENTS ---
            const welcomeModal = document.getElementById('welcome-modal');
            const welcomeForm = document.getElementById('welcome-form');
            const userNameInput = document.getElementById('user-name-input');
            const userNameHeader = document.getElementById('user-name-header');
            const currencySelector = document.getElementById('currency');
            const incomesContainer = document.getElementById('incomes-container');
            const addIncomeBtn = document.getElementById('add-income');
            const variableExpenseForm = document.getElementById('variable-expense-form');
            const variableExpensesList = document.getElementById('variable-expenses-list');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpensesEl = document.getElementById('total-expenses');
            const allocatedSavingsEl = document.getElementById('allocated-savings');
            const cashFlowEl = document.getElementById('cash-flow');
            
            // Diagnosis Section Elements
            const resetBtn = document.getElementById('reset-btn');
            const diagnoseBtn = document.getElementById('diagnose-btn');
            const financialHealthEl = document.getElementById('financial-health');
            const healthStatusEl = document.getElementById('health-status');
            const healthMessageEl = document.getElementById('health-message');
            const detailedAnalysisEl = document.getElementById('detailed-analysis');
            const actionPathContainer = document.getElementById('action-path-container');
            const recommendationsEl = document.getElementById('recommendations');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            
            const chartCanvasEl = document.getElementById('expenses-chart');
            const chartCanvas = chartCanvasEl.getContext('2d');

            // --- USER PERSONALIZATION ---
            function loadUser() {
                const userName = localStorage.getItem('userName');
                if (!userName) {
                    welcomeModal.classList.remove('hidden');
                } else {
                    userNameHeader.textContent = userName;
                }
            }

            welcomeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userName = userNameInput.value.trim();
                if (userName) {
                    localStorage.setItem('userName', userName);
                    userNameHeader.textContent = userName;
                    welcomeModal.classList.add('hidden');
                }
            });

            // --- UTILITY FUNCTIONS ---
            const parseFormattedNumber = (value) => parseFloat(String(value).replace(/\./g, '')) || 0;

            const formatInputAsNumber = (e) => {
                const input = e.target;
                const rawValue = input.value.replace(/[^\d]/g, '');
                input.value = rawValue ? new Intl.NumberFormat('es-CO').format(rawValue) : '';
            };
            
            // --- FORMATTING ---
            const formatCurrency = (amount) => {
                const options = { style: 'currency', currency: state.currency, minimumFractionDigits: 0, maximumFractionDigits: 0 };
                if (state.currency === 'USD') {
                    options.minimumFractionDigits = 2;
                    options.maximumFractionDigits = 2;
                }
                return new Intl.NumberFormat('es-CO', options).format(amount);
            };

            // --- DATA PERSISTENCE FUNCTIONS ---
            function saveData() {
                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

                const dataToSave = {
                    incomes: [],
                    fixedExpenses: [],
                    variableExpenses: state.variableExpenses,
                    currency: currencySelector.value
                };
                document.querySelectorAll('#incomes-container input').forEach(input => {
                    dataToSave.incomes.push(input.value);
                });
                document.querySelectorAll('.fixed-expense').forEach(input => {
                    dataToSave.fixedExpenses.push(input.value);
                });

                const allData = JSON.parse(localStorage.getItem('financieroDataHistory')) || {};
                allData[currentMonthKey] = dataToSave;
                localStorage.setItem('financieroDataHistory', JSON.stringify(allData));
            }

            function loadData() {
                const allData = JSON.parse(localStorage.getItem('financieroDataHistory')) || {};
                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const data = allData[currentMonthKey];

                if (data) {
                    currencySelector.value = data.currency || 'COP';
                    state.currency = data.currency || 'COP';

                    const incomeInputs = document.querySelectorAll('#incomes-container input');
                    incomeInputs.forEach((input, index) => {
                        if (data.incomes[index]) input.value = data.incomes[index];
                    });
                    for (let i = incomeInputs.length; i < data.incomes.length; i++) {
                        addIncomeBtn.click();
                        const newInput = document.querySelector('#incomes-container div:last-child input');
                        newInput.value = data.incomes[i];
                    }

                    document.querySelectorAll('.fixed-expense').forEach((input, index) => {
                        if (data.fixedExpenses[index]) input.value = data.fixedExpenses[index];
                    });

                    state.variableExpenses = data.variableExpenses || [];
                    renderVariableExpenses();
                    updateDashboard();
                }
            }

            // --- EVENT LISTENERS ---
            currencySelector.addEventListener('change', (e) => {
                state.currency = e.target.value;
                updateDashboard();
            });

            addIncomeBtn.addEventListener('click', () => {
                const newIncomeDiv = document.createElement('div');
                newIncomeDiv.className = 'relative';
                newIncomeDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="flex-grow">
                             <label class="text-sm font-medium text-slate-700">Otro Ingreso</label>
                             <input type="text" inputmode="decimal" placeholder="Ej: 500.000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 data-input">
                        </div>
                        <button class="remove-income self-end mb-1 text-slate-400 hover:text-red-600 transition-colors" title="Eliminar ingreso">
                            <i class="gg-trash"></i>
                        </button>
                    </div>
                `;
                const newInput = newIncomeDiv.querySelector('input');
                newInput.addEventListener('input', formatInputAsNumber);
                newInput.addEventListener('input', updateDashboard);
                newIncomeDiv.querySelector('.remove-income').addEventListener('click', () => {
                    newIncomeDiv.remove();
                    updateDashboard();
                });
                incomesContainer.appendChild(newIncomeDiv);
            });

            variableExpenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const description = document.getElementById('expense-desc').value;
                const amount = parseFormattedNumber(document.getElementById('expense-amount').value);
                const category = document.getElementById('expense-category').value;

                if (description && amount > 0) {
                    state.variableExpenses.push({ id: Date.now(), description, amount, category });
                    renderVariableExpenses();
                    updateDashboard();
                    variableExpenseForm.reset();
                }
            });
            
            document.querySelectorAll('.data-input, #expense-amount').forEach(input => {
                input.addEventListener('input', formatInputAsNumber);
                input.addEventListener('input', updateDashboard);
            });

            diagnoseBtn.addEventListener('click', runDiagnosis);
            resetBtn.addEventListener('click', resetAllData);
            exportPdfBtn.addEventListener('click', exportToPDF);

            // --- RENDER FUNCTIONS ---
            const renderVariableExpenses = () => {
                variableExpensesList.innerHTML = state.variableExpenses.length === 0 
                    ? `<p class="text-center text-sm text-slate-500">Aún no has añadido gastos variables.</p>` 
                    : '';
                if (state.variableExpenses.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    state.variableExpenses.forEach(expense => {
                        const item = document.createElement('li');
                        item.className = 'flex justify-between items-center bg-slate-50 p-2 rounded-md';
                        item.innerHTML = `
                            <div>
                                <span class="font-medium">${expense.description}</span>
                                <span class="text-xs text-slate-500 block">${expense.category}</span>
                            </div>
                            <div class="flex items-center gap-4">
                               <span class="font-semibold">${formatCurrency(expense.amount)}</span>
                               <button data-id="${expense.id}" class="remove-expense text-red-500 hover:text-red-700 text-2xl leading-none">&times;</button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                    variableExpensesList.appendChild(list);

                    document.querySelectorAll('.remove-expense').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const idToRemove = parseInt(e.target.dataset.id);
                            state.variableExpenses = state.variableExpenses.filter(exp => exp.id !== idToRemove);
                            renderVariableExpenses();
                            updateDashboard();
                        });
                    });
                }
            };
            
            Chart.register(ChartDataLabels);

            const renderChart = (expenseCategories) => {
                if (expenseChart) expenseChart.destroy();
                const labels = Object.keys(expenseCategories);
                const data = Object.values(expenseCategories);

                if (labels.length === 0) {
                    chartCanvasEl.parentElement.parentElement.classList.add('hidden');
                    return;
                }
                chartCanvasEl.parentElement.parentElement.classList.remove('hidden');

                expenseChart = new Chart(chartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Gastos por Categoría',
                            data: data,
                            backgroundColor: ['rgba(79, 70, 229, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(96, 165, 250, 0.8)'],
                            borderColor: 'rgba(255, 255, 255, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { callbacks: { label: (context) => `${context.label || ''}: ${formatCurrency(context.parsed)}` } },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = (value / total * 100);
                                    return percentage > 5 ? percentage.toFixed(1) + "%" : '';
                                },
                                color: '#fff',
                                font: { weight: 'bold', size: 14 }
                            }
                        }
                    }
                });
            };
            
            // --- CORE LOGIC ---
            function updateDashboard() {
                let totalIncome = 0;
                document.querySelectorAll('#incomes-container input').forEach(input => totalIncome += parseFormattedNumber(input.value));

                let totalFixedExpenses = 0;
                document.querySelectorAll('.fixed-expense').forEach(input => totalFixedExpenses += parseFormattedNumber(input.value));

                const totalVariableExpenses = state.variableExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const totalExpenses = totalFixedExpenses + totalVariableExpenses;
                
                const allocatedSavings = parseFloat(localStorage.getItem('totalAllocatedSavings')) || 0;
                allocatedSavingsEl.textContent = formatCurrency(allocatedSavings);

                const cashFlow = totalIncome - totalExpenses - allocatedSavings;

                totalIncomeEl.textContent = formatCurrency(totalIncome);
                totalExpensesEl.textContent = formatCurrency(totalExpenses);
                cashFlowEl.textContent = formatCurrency(cashFlow);
                cashFlowEl.classList.toggle('text-green-600', cashFlow >= 0);
                cashFlowEl.classList.toggle('text-red-600', cashFlow < 0);

                const expenseCategories = {};
                if (totalFixedExpenses > 0) expenseCategories['Gastos Fijos'] = totalFixedExpenses;
                state.variableExpenses.forEach(exp => {
                    expenseCategories[exp.category] = (expenseCategories[exp.category] || 0) + exp.amount;
                });
                renderChart(expenseCategories);

                resetDiagnosisSection();
                saveData();
            }
            
            function resetAllData() {
                localStorage.removeItem('financieroDataHistory');
                localStorage.removeItem('financialBudget');
                localStorage.removeItem('financialGoals');
                localStorage.removeItem('totalAllocatedSavings');
                localStorage.removeItem('userName'); // Clear user name
                document.querySelectorAll('.data-input').forEach(input => input.value = '');
                const dynamicIncomes = incomesContainer.querySelectorAll('div:not(:first-child)');
                dynamicIncomes.forEach(div => div.remove());
                variableExpenseForm.reset();
                state.variableExpenses = [];
                renderVariableExpenses();
                updateDashboard();
                location.reload(); // Reload to show welcome modal
            }

            function resetDiagnosisSection() {
                diagnoseBtn.classList.remove('hidden');
                financialHealthEl.classList.add('hidden');
                detailedAnalysisEl.classList.add('hidden');
                recommendationsEl.classList.add('hidden');
                actionPathContainer.innerHTML = '';
                exportPdfBtn.classList.add('hidden');
                state.currentDiagnosis = null;
                state.investorProfile = null;
            }

            function runDiagnosis() {
                let totalIncome = 0;
                document.querySelectorAll('#incomes-container input').forEach(input => totalIncome += parseFormattedNumber(input.value));

                if (totalIncome === 0) {
                    financialHealthEl.className = 'text-center p-4 rounded-lg mb-4 bg-amber-100 text-amber-800';
                    healthStatusEl.textContent = 'Datos Incompletos';
                    healthMessageEl.textContent = 'Por favor, ingresa primero tus ingresos para poder generar un diagnóstico.';
                    financialHealthEl.classList.remove('hidden');
                    return;
                }
                
                let totalFixedExpenses = 0;
                document.querySelectorAll('.fixed-expense').forEach(input => totalFixedExpenses += parseFormattedNumber(input.value));
                const totalVariableExpenses = state.variableExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const totalExpenses = totalFixedExpenses + totalVariableExpenses;
                const allocatedSavings = parseFloat(localStorage.getItem('totalAllocatedSavings')) || 0;
                const cashFlow = totalIncome - totalExpenses - allocatedSavings;

                const savingPercentage = (cashFlow / totalIncome) * 100;
                let status, message, bgColor, textColor;

                if (cashFlow < 0) {
                    [status, message, bgColor, textColor] = ['Crítica', 'Estás en un punto de inflexión. ¡Es el momento perfecto para tomar decisiones valientes!', 'bg-red-100', 'text-red-800'];
                } else if (savingPercentage < 10) {
                    [status, message, bgColor, textColor] = ['En Riesgo', 'Estás cerca del equilibrio. Unos pequeños ajustes estratégicos harán una gran diferencia.', 'bg-amber-100', 'text-amber-800'];
                } else if (savingPercentage <= 20) {
                    [status, message, bgColor, textColor] = ['Estable', 'Has construido una base sólida. Es momento de pasar de ahorrar a construir patrimonio.', 'bg-blue-100', 'text-blue-800'];
                } else {
                    [status, message, bgColor, textColor] = ['Saludable', '¡Excelente! Tienes el control. Ahora el juego es optimizar y acelerar tu crecimiento.', 'bg-green-100', 'text-green-800'];
                }

                financialHealthEl.className = `text-center p-4 rounded-lg mb-4 ${bgColor} ${textColor}`;
                healthStatusEl.textContent = `Salud Financiera: ${status}`;
                healthMessageEl.textContent = message;

                const fixedPercentage = totalIncome > 0 ? (totalFixedExpenses / totalIncome * 100).toFixed(1) : 0;
                const variablePercentage = totalIncome > 0 ? (totalVariableExpenses / totalIncome * 100).toFixed(1) : 0;
                detailedAnalysisEl.innerHTML = `
                    <h4 class="font-semibold text-slate-900">Análisis de Gastos</h4>
                    <p class="mt-1">Tus <strong>gastos fijos</strong> representan el <strong>${fixedPercentage}%</strong> de tus ingresos.</p>
                    <p class="mt-1">Tus <strong>gastos variables</strong> representan el <strong>${variablePercentage}%</strong> de tus ingresos.</p>
                `;

                diagnoseBtn.classList.add('hidden');
                financialHealthEl.classList.remove('hidden');
                detailedAnalysisEl.classList.remove('hidden');
                
                const expenseCategories = {};
                if (totalFixedExpenses > 0) expenseCategories['Gastos Fijos'] = totalFixedExpenses;
                state.variableExpenses.forEach(exp => {
                    expenseCategories[exp.category] = (expenseCategories[exp.category] || 0) + exp.amount;
                });
                state.currentDiagnosis = { status, expenseCategories };

                generateInitialRecommendations(status, {totalIncome, ...state.currentDiagnosis});
                recommendationsEl.classList.remove('hidden');

                showActionPath(status, totalIncome - totalExpenses); // Pass cashflow before goal savings
            }
            
            function showActionPath(status, cashFlow) {
                actionPathContainer.innerHTML = '';

                const ctaTemplates = {
                    progress: document.getElementById('progress-cta-template'),
                    progressOnboarding: document.getElementById('progress-onboarding-template'),
                    budget: document.getElementById('budget-cta-template'),
                    debts: document.getElementById('debts-cta-template'),
                    goals: document.getElementById('goals-cta-template'),
                    investor: document.getElementById('investor-profile-template'),
                    investmentRecs: document.getElementById('investment-recommendations-template')
                };

                const appendCta = (template) => {
                    const clone = template.content.cloneNode(true);
                    actionPathContainer.appendChild(clone);
                };

                const historyLength = Object.keys(JSON.parse(localStorage.getItem('financieroDataHistory')) || {}).length;
                if (historyLength > 1) {
                    appendCta(ctaTemplates.progress);
                } else {
                    appendCta(ctaTemplates.progressOnboarding);
                }

                const paths = {
                    'Crítica': ['debts', 'budget', 'goals'],
                    'En Riesgo': ['budget', 'debts', 'goals'],
                    'Estable': ['goals', 'budget', 'investor'],
                    'Saludable': ['goals', 'investor', 'budget']
                };

                const currentPath = paths[status];
                currentPath.forEach(ctaKey => {
                    if (ctaKey === 'goals') {
                        appendCta(ctaTemplates.goals);
                        showGoalsCta(status, cashFlow);
                    } else if (ctaKey === 'investor') {
                        appendCta(ctaTemplates.investor);
                        actionPathContainer.querySelector('#investor-profile-container').addEventListener('click', (e) => {
                            if (e.target.classList.contains('profile-btn')) {
                                state.investorProfile = e.target.dataset.profile;
                                actionPathContainer.querySelector('#investor-profile-container').classList.add('hidden');
                                showInvestmentPlan();
                            }
                        });
                    } else {
                        appendCta(ctaTemplates[ctaKey]);
                    }
                });
                
                if (status === 'Crítica' || status === 'En Riesgo') {
                    exportPdfBtn.classList.remove('hidden');
                }
            }

            function showGoalsCta(status, cashFlow) {
                const goalsContainer = actionPathContainer.querySelector('#goals-cta-container');
                if (!goalsContainer) return;

                let ctaTitle, ctaText, ctaButtonText;
                
                 switch (status) {
                    case 'Crítica':
                        ctaTitle = 'Define tu "Porqué" para Salir Adelante';
                        ctaText = 'Incluso en momentos difíciles, tener una meta clara te dará la fuerza para seguir. Crea un pequeño objetivo que te motive a dar el primer paso.';
                        ctaButtonText = 'Crear mi Meta de Escape →';
                        break;
                    case 'En Riesgo':
                        ctaTitle = 'Dale un Propósito a tu Ahorro';
                        ctaText = 'Estás a un paso de la estabilidad. Crear una meta convierte el ahorro de una obligación a una emocionante misión.';
                        ctaButtonText = 'Crear mi Primera Misión →';
                        break;
                    default:
                        ctaTitle = '¡Es Momento de Soñar en Grande!';
                        ctaText = 'Tienes un flujo de caja positivo. Es el momento perfecto para ponerle un nombre a tus sueños y empezar a construir tu futuro hoy.';
                        ctaButtonText = 'Crear mi Primera Meta →';
                        break;
                }

                goalsContainer.querySelector('#goals-cta-title').textContent = ctaTitle;
                goalsContainer.querySelector('#goals-cta-text').textContent = ctaText;
                const goalsBtn = goalsContainer.querySelector('#go-to-goals-btn');
                goalsBtn.textContent = ctaButtonText;
                
                goalsBtn.addEventListener('click', () => {
                    if (cashFlow > 0) {
                        localStorage.setItem('availableCashFlow', cashFlow);
                    } else {
                        localStorage.removeItem('availableCashFlow');
                    }
                });
            }

            function showInvestmentPlan() {
                if (!state.currentDiagnosis || !state.investorProfile) return;
                
                const investmentContainer = document.importNode(document.getElementById('investment-recommendations-template').content, true).firstElementChild;
                actionPathContainer.appendChild(investmentContainer);
                generateInvestmentRecommendations(state.investorProfile, investmentContainer);
                exportPdfBtn.classList.remove('hidden');
            }

            function generateInitialRecommendations(status, data) {
                recommendationsEl.innerHTML = ' <h4 class="font-semibold text-xl text-slate-800 mb-2">Tu Plan de Acción Personalizado</h4>';
                const addHook = (text) => {
                    recommendationsEl.innerHTML += `<div class="p-3 bg-yellow-100 text-yellow-800 rounded-md border-l-4 border-yellow-500 font-semibold">${text}</div>`;
                };
                const addRecommendation = (title, text) => {
                    recommendationsEl.innerHTML += `
                        <div class="p-3 bg-slate-50 rounded-md border-l-4 border-indigo-500">
                            <h4 class="font-semibold text-slate-900">${title}</h4>
                            <p class="mt-1">${text}</p>
                        </div>`;
                };
                
                const smallExpenses = state.variableExpenses.filter(e => e.amount < (state.currency === 'COP' ? 30000 : 10));
                const subscriptionCost = parseFormattedNumber(document.querySelector('[data-category="Suscripciones"]').value);
                const educationSpending = data.expenseCategories['Educación'] || 0;
                
                let variableCategories = {...data.expenseCategories};
                delete variableCategories['Gastos Fijos'];
                const highestVariableCategory = Object.keys(variableCategories).length > 0
                    ? Object.entries(variableCategories).reduce((a, b) => a[1] > b[1] ? a : b)
                    : [null, 0];

                switch (status) {
                    case 'Crítica':
                        addHook(`Tu punto de acción inmediato es claro: necesitas generar un flujo de caja positivo. Vamos a enfocarnos en victorias rápidas para darte un respiro y recuperar el control.`);
                        addRecommendation('Misión #1: La Victoria de los 10 Minutos', 'Tu único objetivo ahora es tomar UNA decisión que te devuelva el control. Cancela UNA suscripción, haz UNA llamada para negociar un pago. El objetivo no es el dinero, es la victoria psicológica. ¡Hazlo ahora!');
                        if (highestVariableCategory[0]) {
                            addRecommendation(`Misión #2: Auditoría de Emergencia en "${highestVariableCategory[0]}"`, `Tu mayor gasto variable es en <strong>${highestVariableCategory[0]}</strong>. Revisa cada transacción de esta categoría y pregúntate: "¿Podría haber vivido sin esto?". Identifica un 10% que puedas cortar de inmediato.`);
                        }
                        addRecommendation('Misión #3: La "Caja de Efectivo Semanal"', 'Saca en efectivo el dinero para tus gastos variables de la semana (comida, transporte). Usa SOLO ese dinero. Verlo disminuir físicamente te reconecta con el valor real de tus gastos.');
                        break;
                    case 'En Riesgo':
                        if (highestVariableCategory[0] && (highestVariableCategory[1] / data.totalIncome > 0.15)) {
                            addHook(`Hemos encontrado tu mayor oportunidad: Tu gasto en <strong>'${highestVariableCategory[0]}'</strong> representa el <strong>${(highestVariableCategory[1] / data.totalIncome * 100).toFixed(0)}%</strong> de tus ingresos. Optimizar esta área podría llevarte de 'En Riesgo' a 'Estable'.`);
                            addRecommendation('Paso 1: La Auditoría de Felicidad', `Revisa los gastos de '${highestVariableCategory[0]}' y califícalos del 1 al 10 según la felicidad que te aportaron. El objetivo es identificar los gastos que haces por inercia (calificación < 7).`);
                            addRecommendation('Paso 2: El Reto del 20%', `Para el próximo mes, te retamos a reducir tu presupuesto de '${highestVariableCategory[0]}' en un 20%. Esto liberaría <strong>${formatCurrency(highestVariableCategory[1] * 0.2)}</strong> directamente para tu ahorro.`);
                            addRecommendation('Paso 3: El Reemplazo Inteligente', `Busca una alternativa gratuita para una de tus actividades habituales en esta categoría. Anota cuánto ahorraste con ese único cambio para ver el poder de las pequeñas decisiones.`);
                        } else {
                            addHook(`Estás muy cerca del equilibrio. Tu misión es crear un "colchón" de ahorro consistente. Estos hábitos automáticos lo harán por ti sin que apenas te des cuenta.`);
                            addRecommendation('Hábito Atómico: La Regla del 1%', 'Cada mes, aumenta tu tasa de ahorro en solo un 1%. Es un cambio tan pequeño que no lo sentirás en tu día a día, pero en un año estarás ahorrando un 12% adicional de tus ingresos sin esfuerzo.');
                            addRecommendation('Reto de 48 Horas: "El Enfriamiento"', 'Para cualquier compra no esencial superior a $50.000 COP / $15 USD, ponla en una lista de "enfriamiento" por 48 horas. Si después de dos días todavía la quieres y es una decisión inteligente, adelante. El 90% de los impulsos no sobrevivirán.');
                            if (subscriptionCost > 0) {
                                addRecommendation('Alerta de Suscripciones Fantasma', `Tus suscripciones suman <strong>${formatCurrency(subscriptionCost * 12)} al año</strong>. Te retamos a una 'auditoría de 5 minutos': abre tu app store, revisa tus suscripciones activas y cancela al menos una. Es dinero que recuperas al instante.`);
                            }
                        }
                        break;
                    case 'Estable':
                        addHook(`Has construido una base sólida. Ahora el juego cambia: pasamos de 'ahorrar' a 'construir patrimonio'. Tu misión es hacer que tu dinero empiece a trabajar para ti.`);
                        addRecommendation('Fundamento Sólido: El Fondo "Anti-Murphy"', 'Olvídate de los "6 meses de gastos". Tu primera meta es un fondo de emergencia de un millón de pesos (o $250 USD). Es tu barrera contra pequeñas crisis. Es una meta rápida y te dará una inmensa paz mental.');
                        if (educationSpending === 0) {
                             addRecommendation('Acelerador de Riqueza: Invierte en tu "Capital Humano"', 'Tu mayor activo eres tú. Notamos que no tienes gastos en "Educación". Usar una parte de tu ahorro para adquirir una habilidad de alta demanda puede aumentar tu ingreso principal, superando cualquier retorno del mercado de valores.');
                        }
                        addRecommendation('Siguiente Nivel: Tu Primer "Micro-Portafolio"', 'La inversión no tiene por qué ser compleja. Ahora que tienes una base, es el momento de poner tu dinero a trabajar. Define tu perfil de inversor a continuación para recibir estrategias claras.');
                        break;
                    case 'Saludable':
                        addHook(`¡Excelente! Tienes el control total. Tu misión ahora es optimizar y acelerar tu camino hacia la libertad financiera. Pequeños ajustes en esta etapa tienen un impacto gigantesco a largo plazo.`);
                        addRecommendation('Estrategia de Crecimiento: El "Fondo de Oportunidades"', 'Además de tu fondo de emergencia, crea un "Fondo de Oportunidades". Es dinero líquido destinado a aprovechar caídas del mercado o ideas de negocio inesperadas. Cuando todos venden por pánico, tú compras con calma.');
                        addRecommendation('Optimización Avanzada: Eficiencia Fiscal', 'Investiga sobre productos financieros que ofrezcan beneficios fiscales en tu país (pensiones voluntarias, AFCs). Pagar menos impuestos legalmente es una forma sofisticada de acelerar tu patrimonio.');
                        addRecommendation('Visión a Largo Plazo: Define tu Estrategia de Inversión', 'Es hora de que tu dinero trabaje tan duro como tú. Elige tu perfil de inversor a continuación para diseñar tu portafolio ideal.');
                        break;
                }
            }
            
            function generateInvestmentRecommendations(profile, container) {
                container.innerHTML = '<h4 class="font-semibold text-xl text-slate-800 mb-2">Estrategias de Inversión Potentes</h4>';
                const addRecommendation = (title, text) => {
                    container.innerHTML += `
                        <div class="p-3 bg-slate-50 rounded-md border-l-4 border-green-500">
                            <h4 class="font-semibold text-slate-900">${title}</h4>
                            <p class="mt-1">${text}</p>
                        </div>`;
                };

                addRecommendation(`Plan de Inversión para un Perfil ${profile.charAt(0).toUpperCase() + profile.slice(1)}`, `Basado en tu perfil, aquí tienes una estrategia de inversión potente y clara para empezar a construir tu patrimonio.`);

                switch(profile) {
                    case 'conservador':
                        addRecommendation('Estrategia "Escalera de Bonos"', 'En lugar de poner todo en un solo CDT, diversifica en varios con diferentes vencimientos (ej. a 90, 180, 365 días). A medida que venzan, los reinviertes a las tasas actuales. Esto te protege de las fluctuaciones de las tasas de interés y te da liquidez periódica.');
                        addRecommendation('El Pilar Inmobiliario: FIBRAS/REITs', 'Invierte en el mercado inmobiliario sin comprar una propiedad. Los fondos de inversión inmobiliaria (FIBRAS en México, REITs en USA, o a través de fondos en Colombia) te permiten recibir rentas de centros comerciales, oficinas, etc., con bajo capital y alta diversificación.');
                        break;
                    case 'moderado':
                        addRecommendation('El Núcleo de tu Portafolio: La Estrategia "Core-Satellite"', 'Asigna el 70% de tu inversión ("Core") a un ETF de bajo costo que siga al mercado global (ej. VT). Usa el 30% restante ("Satellite") para apuestas más concentradas, como un ETF del sector tecnológico (ej. QQQ) o acciones de una empresa local que conozcas bien.');
                        addRecommendation('Inversión Temática: Megatendencias', 'Dedica una pequeña parte de tu portafolio a invertir en el futuro. Elige una o dos "megatendencias" que creas que dominarán los próximos años (ej. Inteligencia Artificial, Energías Limpias, Ciberseguridad) e invierte a través de ETFs especializados.');
                        break;
                    case 'agresivo':
                        addRecommendation('Potencial de Crecimiento: Acciones "Small-Cap"', 'Las grandes empresas ya crecieron. El verdadero potencial exponencial está en las empresas más pequeñas e innovadoras ("small-caps"). Invierte a través de un ETF (ej. IWM) para diversificar el riesgo y capturar el crecimiento de las futuras líderes del mercado.');
                        addRecommendation('La Frontera Digital: Activos Digitales con Propósito', 'Más allá de la especulación, asigna un 1-3% de tu portafolio a criptoactivos sólidos con casos de uso claros (ej. Ethereum para contratos inteligentes, o proyectos de finanzas descentralizadas - DeFi). Es una apuesta asimétrica: el riesgo es limitado, pero el potencial de ganancia es enorme.');
                        break;
                }
            }

            function exportToPDF() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const exportButton = document.getElementById('export-pdf-btn');
                exportButton.textContent = 'Generando PDF...';

                let y = 15;
                const pageHeight = pdf.internal.pageSize.getHeight();
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 15;
                const maxWidth = pageWidth - margin * 2;

                const addSection = (title, contentFn) => {
                    if (y + 20 > pageHeight - margin) { pdf.addPage(); y = margin; }
                    pdf.setFontSize(16); pdf.setFont(undefined, 'bold');
                    pdf.text(title, margin, y); y += 8;
                    pdf.setFont(undefined, 'normal'); pdf.setFontSize(11);
                    contentFn();
                };
                
                const addWrappedText = (text, options = {}) => {
                    const lines = pdf.splitTextToSize(text.replace(/<strong>|<\/strong>/g, ''), options.maxWidth || maxWidth);
                    const lineHeight = 6;
                    if (y + (lines.length * lineHeight) > pageHeight - margin) { pdf.addPage(); y = margin; }
                    pdf.text(lines, margin + (options.indent || 0), y);
                    y += lines.length * lineHeight;
                };

                pdf.setFontSize(24); pdf.setFont(undefined, 'bold');
                pdf.text("Mi Primer Plan Financiero", pageWidth / 2, y, { align: 'center' }); y += 8;
                pdf.setFontSize(10); pdf.setFont(undefined, 'normal');
                pdf.text(`Reporte generado el: ${new Date().toLocaleDateString('es-ES')}`, pageWidth / 2, y, { align: 'center' }); y += 15;

                addSection("1. Resumen Financiero", () => {
                    pdf.text(`Ingresos Totales: ${totalIncomeEl.textContent}`, margin, y); y += 7;
                    pdf.text(`Gastos Totales: ${totalExpensesEl.textContent}`, margin, y); y += 7;
                    pdf.text(`Flujo de Caja Mensual: ${cashFlowEl.textContent}`, margin, y); y += 10;
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Diagnóstico: ${healthStatusEl.textContent}`, margin, y); y += 7;
                    pdf.setFont(undefined, 'normal');
                    addWrappedText(healthMessageEl.textContent); y += 5;
                });

                addSection("2. Distribución de Gastos", () => {
                    const chartImage = chartCanvasEl.toDataURL('image/png', 1.0);
                    const chartHeight = 80;
                    if (y + chartHeight > pageHeight - margin) { pdf.addPage(); y = margin; }
                    pdf.addImage(chartImage, 'PNG', margin, y, 100, chartHeight);
                    y += chartHeight + 10;
                });

                addSection("3. Tu Plan de Acción Inicial", () => {
                    const hook = recommendationsEl.querySelector('div:first-child');
                    if(hook && hook.classList.contains('bg-yellow-100')) {
                        pdf.setFont(undefined, 'bold');
                        addWrappedText(`Tu Oportunidad Clave: ${hook.innerText}`);
                        y += 4;
                    }
                    recommendationsEl.querySelectorAll('div.border-indigo-500').forEach(rec => {
                        const title = rec.querySelector('h4').innerText;
                        const text = rec.querySelector('p').innerText;
                        pdf.setFont(undefined, 'bold'); addWrappedText(title); y += 2;
                        pdf.setFont(undefined, 'normal'); addWrappedText(text, { indent: 5 }); y += 8;
                    });
                });
                
                if (state.investorProfile) {
                    addSection("4. Estrategias de Inversión", () => {
                        actionPathContainer.querySelector('#investment-recommendations').querySelectorAll('div').forEach(rec => {
                            const title = rec.querySelector('h4').innerText;
                            const text = rec.querySelector('p').innerText;
                            pdf.setFont(undefined, 'bold'); addWrappedText(title); y += 2;
                            pdf.setFont(undefined, 'normal'); addWrappedText(text, { indent: 5 }); y += 8;
                        });
                    });
                }
                
                pdf.save('Mi-Primer-Plan-Financiero.pdf');
                exportButton.textContent = 'Mi Primer Plan Financiero (PDF)';
            }

            // --- INITIALIZATION ---
            loadUser();
            loadData();
            renderVariableExpenses();
            updateDashboard();
        });
    </script>
</body>
</html>
